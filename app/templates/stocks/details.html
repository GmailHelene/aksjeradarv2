{% extends 'base.html' %}
{% block title %}{{ ticker }} - Detaljer{% endblock %}
{% block head %}
<script src="https://cdn.plot.ly/plotly-2.29.1.min.js"></script>
{% endblock %}
{% block content %}
<div class="container mt-4">
  <h1>{{ ticker }} - Aksjedetaljer</h1>

  <div class="row mb-4">
    <div class="col-md-8">
      <div class="card">
        <div class="card-header">
          <h2>Kursutvikling (3 måneder)</h2>
        </div>
        <div class="card-body">
          <div id="stock-chart" style="height: 400px;"></div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h2>Oversikt</h2>
        </div>
        <div class="card-body">
          <table class="table">
            <tbody>
              <tr>
                <th>Siste kurs</th>
                <td>{{ stock_data['Close'].iloc[-1].item() if stock_data is defined and not stock_data.empty else 'N/A' }}</td>
              </tr>
              <tr>
                <th>Endring (dag)</th>
                {% if stock_data is defined and not stock_data.empty %}
                  {% set last_close = stock_data['Close'].iloc[-1].item() %}
                  {% set prev_close = stock_data['Close'].iloc[-2].item() if stock_data.shape[0] > 1 else stock_data['Open'].iloc[-1].item() %}
                  {% set change = last_close - prev_close %}
                  {% set change_percent = (change / prev_close * 100) if prev_close > 0 else 0 %}
                  <td class="{% if change > 0 %}text-success{% elif change < 0 %}text-danger{% endif %}">
                    {{ "%.2f"|format(change) }} ({{ "%.2f"|format(change_percent) }}%)
                  </td>
                {% else %}
                  <td>N/A</td>
                {% endif %}
              </tr>
              <tr>
                <th>Volum (dag)</th>
                <td>{{ stock_data['Volume'].iloc[-1].item()|int if stock_data is defined and not stock_data.empty and 'Volume' in stock_data else 'N/A' }}</td>
              </tr>
              <tr>
                <th>52-uker høy</th>
                <td>{{ stock_data['High'].max().item()|round(2) if stock_data is defined and not stock_data.empty else 'N/A' }}</td>
              </tr>
              <tr>
                <th>52-uker lav</th>
                <td>{{ stock_data['Low'].min().item()|round(2) if stock_data is defined and not stock_data.empty else 'N/A' }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
  
  {% if technical_analysis %}
  <div class="card mb-4">
    <div class="card-header">
      <h2>Teknisk analyse</h2>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <table class="table">
            <tbody>
              <tr>
                <th>Signal</th>
                <td class="{% if technical_analysis.signal == 'Buy' %}text-success{% elif technical_analysis.signal == 'Sell' %}text-danger{% else %}text-warning{% endif %}">
                  {{ technical_analysis.signal }}
                </td>
                <td>
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Samlet handelssignal basert på tekniske indikatorer. 'Buy' indikerer positivt momentum, 'Sell' indikerer negativt momentum, og 'Hold' indikerer usikkerhet eller sidelengs bevegelse."></i>
                </td>
              </tr>
              <tr>
                <th>RSI (14)</th>
                <td>{{ technical_analysis.rsi }}</td>
                <td>
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Relative Strength Index måler momentumet i prisendringer. Verdier over 70 indikerer overkjøp, under 30 indikerer oversalg. Data er beregnet over 14 dager."></i>
                </td>
              </tr>
              <tr>
                <th>MACD</th>
                <td>{{ technical_analysis.macd }}</td>
                <td>
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Moving Average Convergence Divergence er en trendindikator som viser forholdet mellom to glidende gjennomsnitt. Positive verdier tyder på opptrend, negative på nedtrend."></i>
                </td>
              </tr>
              <tr>
                <th>Støtte/Motstand</th>
                <td>{{ technical_analysis.support }}/{{ technical_analysis.resistance }}</td>
                <td>
                  <i class="bi bi-info-circle" data-bs-toggle="tooltip" title="Støttenivå er der aksjen har stoppet å falle tidligere. Motstandsnivå er der aksjen har stoppet å stige tidligere. Verdiene er beregnet fra historiske prisdata."></i>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="col-md-6">
          {% if technical_analysis.signal_reason %}
          <div class="alert alert-info">
            <h5>Begrunnelse:</h5>
            <p>{{ technical_analysis.signal_reason }}</p>
            <small class="text-muted">Sist oppdatert: {% now 'Y-m-d H:i' %} (alle analyser oppdateres daglig)</small>
          </div>
          {% endif %}
        </div>
      </div>
      
      <div class="mt-4">
        <h4>Tekniske Indikatorer - Forklaring</h4>
        <div class="row">
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">RSI (Relative Strength Index)</div>
              <div class="card-body">
                <p>RSI er en momentumoscillator som måler hastigheten og endringen av prissvingninger. RSI svinger mellom 0 og 100.</p>
                <ul>
                  <li>RSI > 70: Aksjen kan være overkjøpt</li>
                  <li>RSI < 30: Aksjen kan være oversolgt</li>
                </ul>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mb-3">
              <div class="card-header">MACD (Moving Average Convergence Divergence)</div>
              <div class="card-body">
                <p>MACD er en trendindikator som viser forholdet mellom to glidende gjennomsnitt.</p>
                <ul>
                  <li>MACD over signallinje: Bullish signal (kjøp)</li>
                  <li>MACD under signallinje: Bearish signal (selg)</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
  
  <div class="d-flex justify-content-between">
    <a href="{{ url_for('stocks.list') }}" class="btn btn-secondary">Tilbake til aksjeliste</a>
    <div>
      <a href="{{ url_for('analysis.ai', ticker=ticker) }}" class="btn btn-info">AI Analyse</a>
      <a href="https://www.nordnet.no/market/stocks/{{ ticker }}" target="_blank" class="btn btn-primary">Kjøp hos Nordnet</a>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    const tooltips = document.querySelectorAll('[data-bs-toggle="tooltip"]');
    tooltips.forEach(tooltip => {
      new bootstrap.Tooltip(tooltip);
    });
    
    // Bruk data fra serveren hvis tilgjengelig, ellers bruk demodata
    let dates = [];
    let prices = [];
    let volumes = [];
    
    {% if stock_data is defined and not stock_data.empty %}
      // Bruk ekte data fra pandas DataFrame
      {% for date, row in stock_data.iterrows() %}
        dates.push("{{ date.strftime('%Y-%m-%d') }}");
        prices.push({{ row['Close'] }});
        {% if 'Volume' in row %}
          volumes.push({{ row['Volume'] }});
        {% else %}
          volumes.push(0);
        {% endif %}
      {% endfor %}
    {% else %}
      // Lag demodata
      const today = new Date();
      let basePrice = 0;
      
      {% if ticker == 'EQNR.OL' %}
        basePrice = 300;
      {% elif ticker == 'DNB.OL' %}
        basePrice = 200;
      {% elif ticker == 'AAPL' %}
        basePrice = 180;
      {% elif ticker == 'MSFT' %}
        basePrice = 380;
      {% elif ticker == 'AMZN' %}
        basePrice = 170;
      {% elif ticker == 'TSLA' %}
        basePrice = 220;
      {% else %}
        basePrice = 100;
      {% endif %}
      
      for (let i = 90; i >= 0; i--) {
        const date = new Date(today);
        date.setDate(today.getDate() - i);
        dates.push(date.toISOString().split('T')[0]);
        
        // Legg til litt tilfeldig variasjon
        const randomChange = (Math.random() - 0.5) * 5;
        basePrice = basePrice + randomChange;
        if (basePrice < 10) basePrice = 10; // Ikke la prisen gå under 10
        
        prices.push(basePrice);
        volumes.push(Math.floor(Math.random() * 1000000) + 500000);
      }
    {% endif %}
    
    // Opprett pris-grafen
    const trace1 = {
      x: dates,
      y: prices,
      type: 'scatter',
      mode: 'lines',
      name: '{{ ticker }} Pris',
      line: {
        color: 'rgb(49, 130, 189)',
        width: 2
      }
    };
    
    // Opprett volum-bargrafen
    const trace2 = {
      x: dates,
      y: volumes,
      type: 'bar',
      name: 'Volum',
      yaxis: 'y2',
      marker: {
        color: 'rgba(55, 128, 191, 0.3)'
      }
    };
    
    const layout = {
      title: '{{ ticker }} - Kursutvikling (3 måneder)',
      xaxis: {
        title: 'Dato',
        rangeslider: {visible: true},
        type: 'date'
      },
      yaxis: {
        title: 'Pris (NOK)',
        fixedrange: false
      },
      yaxis2: {
        title: 'Volum',
        overlaying: 'y',
        side: 'right',
        showgrid: false
      },
      height: 500,
      margin: {
        l: 50,
        r: 50,
        b: 50,
        t: 50,
        pad: 4
      },
      legend: {
        orientation: 'h',
        y: -0.2
      }
    };
    
    const config = {responsive: true};
    
    Plotly.newPlot('stock-chart', [trace1, trace2], layout, config);
  });
</script>
{% endblock %}