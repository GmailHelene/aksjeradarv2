{% extends 'base.html' %}
{% block title %}Teknisk Analyse{% endblock %}
{% block content %}
{% include 'analysis/_menu.html' %}
<div class="container mt-4">
  <h2>Teknisk Analyse (Aksjer, Krypto, Valuta)</h2>
  
  <div class="alert alert-info mb-4">
    <p>Denne tabellen viser tekniske indikatorer og anbefalinger basert på historiske data. 
    Dataperioden er typisk 60 dager. Signaler (Kjøp/Selg/Hold) er basert på RSI, MACD og støtte/motstandsnivåer.</p>
  </div>
  
  <div class="table-responsive">
    <table class="table table-striped">
      <thead class="thead-dark">
        <tr>
          <th>Ticker</th>
          <th>Siste pris</th>
          <th>Signal</th>
          <th>RSI</th>
          <th>MACD</th>
          <th>Støtte/Motstand</th>
          <th>Detaljer</th>
        </tr>
      </thead>
      <tbody>
        {% for ticker, analysis in analyses.items() %}
        <tr>
          <td><strong>{{ ticker }}</strong>
            {% if analysis.last_update is defined %}
              <br><small class="text-muted">{{ analysis.last_update }}</small>
            {% endif %}
          </td>
          <td>{{ analysis.last_price }}</td>
          <td>
            <span class="{% if analysis.signal == 'Buy' %}text-success{% elif analysis.signal == 'Sell' %}text-danger{% else %}text-warning{% endif %}">
              {{ analysis.signal or 'N/A' }}
            </span>
            {% if analysis.signal_reason %}
            <button type="button" class="btn btn-sm btn-link" data-bs-toggle="tooltip" data-bs-placement="right" title="{{ analysis.signal_reason }}">
              <i class="bi bi-info-circle"></i>
            </button>
            {% endif %}
          </td>
          <td>
            {% if analysis.rsi is defined and analysis.rsi is not none %}
              {{ analysis.rsi|round(2) }}
              {% if analysis.rsi < 30 %}<br><span class="badge bg-success">Oversolgt</span>
              {% elif analysis.rsi > 70 %}<br><span class="badge bg-danger">Overkjøpt</span>
              {% endif %}
            {% else %}
              N/A
            {% endif %}
          </td>
          <td>
            {% if analysis.macd is defined and analysis.macd is not none %}
              {{ analysis.macd|round(2) }}
              {% if analysis.macd > analysis.macd_signal %}<br><span class="badge bg-success">Bullish</span>
              {% else %}<br><span class="badge bg-danger">Bearish</span>
              {% endif %}
            {% else %}
              N/A
            {% endif %} 
          </td>
          <td>
            {% if analysis.support is defined and analysis.resistance is defined %}
              {% if analysis.support is not none and analysis.support != 'nan' and analysis.resistance is not none and analysis.resistance != 'nan' %}
                {{ analysis.support|round(2) if analysis.support is number else 'N/A' }} / {{ analysis.resistance|round(2) if analysis.resistance is number else 'N/A' }}
              {% else %}
                N/A / N/A
              {% endif %}
            {% else %}
              N/A / N/A
            {% endif %}
          </td>
          <td>
            <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#detailModal{{ loop.index }}">
              Vis detaljer
            </button>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modals for each ticker -->
  {% for ticker, analysis in analyses.items() %}
  <div class="modal fade" id="detailModal{{ loop.index }}" tabindex="-1" aria-labelledby="detailModalLabel{{ loop.index }}" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="detailModalLabel{{ loop.index }}">Detaljer for {{ ticker }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="row">
            <div class="col-md-12">
              <div class="alert {% if analysis.signal == 'Buy' %}alert-success{% elif analysis.signal == 'Sell' %}alert-danger{% else %}alert-warning{% endif %}">
                <h4>Signal: {{ analysis.signal }}</h4>
                {% if analysis.signal_reason is defined %}
                <p>{{ analysis.signal_reason }}</p>
                {% endif %}
              </div>
              
              <h5>Tekniske indikatorer</h5>
              <table class="table table-sm">
                <tr>
                  <th>Siste pris</th>
                  <td>{{ analysis.last_price }}</td>
                </tr>
                <tr>
                  <th>RSI</th>
                  <td>{{ analysis.rsi }}</td>
                </tr>
                <tr>
                  <th>MACD</th>
                  <td>{{ analysis.macd }}</td>
                </tr>
                <tr>
                  <th>MACD Signal</th>
                  <td>{{ analysis.macd_signal }}</td>
                </tr>
                <tr>
                  <th>Støttenivå</th>
                  <td>{{ analysis.support }}</td>
                </tr>
                <tr>
                  <th>Motstandsnivå</th>
                  <td>{{ analysis.resistance }}</td>
                </tr>
                <tr>
                  <th>Volum</th>
                  <td>{{ analysis.volume }}</td>
                </tr>
                <tr>
                  <th>Gj. volum (20d)</th>
                  <td>{{ analysis.avg_volume }}</td>
                </tr>
              </table>
              
              <p class="text-muted">
                <small>Sist oppdatert: {{ analysis.last_update if analysis.last_update is defined else 'N/A' }}</small><br>
                <small>Dataperiode: {{ analysis.data_period if analysis.data_period is defined else 'N/A' }}</small>
              </p>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Lukk</button>
          <a href="{{ url_for('analysis.recommendation', ticker=ticker) }}" class="btn btn-primary">Full analyse</a>
        </div>
      </div>
    </div>
  </div>
  {% endfor %}

  <div class="mt-4">
    <h3>Detaljer om signaler</h3>
    <div class="accordion" id="signalAccordion">
      {% for ticker, analysis in analyses.items() %}
      {% if analysis.signal_reason %}
      <div class="accordion-item">
        <h2 class="accordion-header" id="heading{{ loop.index }}">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ loop.index }}" aria-expanded="false" aria-controls="collapse{{ loop.index }}">
            {{ ticker }} - {{ analysis.signal }}
          </button>
        </h2>
        <div id="collapse{{ loop.index }}" class="accordion-collapse collapse" aria-labelledby="heading{{ loop.index }}" data-bs-parent="#signalAccordion">
          <div class="accordion-body">
            <p>{{ analysis.signal_reason }}</p>
            <p><strong>RSI:</strong> {{ analysis.rsi }}</p>
            <p><strong>MACD:</strong> {{ analysis.macd }}</p>
            <p><strong>MACD Signal:</strong> {{ analysis.macd_signal }}</p>
            <p><strong>Støtte/Motstand:</strong> {{ analysis.support }} / {{ analysis.resistance }}</p>
          </div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
    </div>
  </div>
</div>
{% endblock %}
