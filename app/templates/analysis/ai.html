{% extends 'base.html' %}
{% block title %}AI Analyse{% endblock %}
{% block content %}
{% include 'analysis/_menu.html' %}

<div class="container mt-4">
  <h1 class="mb-4">AI Analyse</h1>
  
  {% if ticker %}
    <div class="card mb-4">
      <div class="card-header">
        <h2>{{ ticker }}</h2>
      </div>
      <div class="card-body">
        {% if analysis %}
          <div class="row">
            <div class="col-md-8">
              <div class="alert {% if analysis.signal == 'BUY' %}alert-success{% elif analysis.signal == 'SELL' %}alert-danger{% else %}alert-warning{% endif %} mb-4">
                <h3>{{ analysis.summary }}</h3>
              </div>
              
              <h3 class="mb-3">Fundamental analyse</h3>
              <div class="row mb-4">
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header">Finansielle data</div>
                    <div class="card-body">
                      <table class="table table-sm">
                        <tr>
                          <th>P/E-forhold</th>
                          <td>{{ analysis.metrics.pe_ratio|default('N/A') }}</td>
                        </tr>
                        <tr>
                          <th>EPS (Fortjeneste pr. aksje)</th>
                          <td>{{ analysis.metrics.eps|default('N/A') }}</td>
                        </tr>
                        <tr>
                          <th>Utbytteavkastning</th>
                          <td>{{ analysis.metrics.dividend_yield|default('N/A') }}</td>
                        </tr>
                        <tr>
                          <th>Markedsverdi</th>
                          <td>{{ analysis.metrics.market_cap|default('N/A') }}</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="card h-100">
                    <div class="card-header">Vekstpotensial</div>
                    <div class="card-body">
                      <table class="table table-sm">
                        <tr>
                          <th>Inntektsvekst (YoY)</th>
                          <td>{{ analysis.metrics.revenue_growth|default('N/A') }}</td>
                        </tr>
                        <tr>
                          <th>EPS-vekst (YoY)</th>
                          <td>{{ analysis.metrics.eps_growth|default('N/A') }}</td>
                        </tr>
                        <tr>
                          <th>Forventet vekst (5 år)</th>
                          <td>{{ analysis.metrics.expected_growth|default('N/A') }}</td>
                        </tr>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              
              <h3 class="mb-3">Tekniske indikatorer</h3>
              <div class="table-responsive mb-4">
                <table class="table table-bordered">
                  <thead class="table-light">
                    <tr>
                      <th>Indikator</th>
                      <th>Verdi</th>
                      <th>Signal</th>
                      <th>Betydning</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for indicator in analysis.indicators %}
                    <tr>
                      <td>{{ indicator.name }}</td>
                      <td>{{ indicator.value }}</td>
                      <td>
                        <span class="badge {% if indicator.signal == 'BUY' %}bg-success{% elif indicator.signal == 'SELL' %}bg-danger{% else %}bg-secondary{% endif %}">
                          {{ indicator.signal }}
                        </span>
                      </td>
                      <td>{{ indicator.description }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              <h3 class="mb-3">Markedsstemning og nyheter</h3>
              <div class="card mb-4">
                <div class="card-body">
                  <p><strong>Markedsstemning:</strong> {{ analysis.sentiment }}</p>
                  <p><strong>Nyhetsanalyse:</strong> {{ analysis.news_summary }}</p>
                  
                  {% if analysis.recent_news %}
                  <h4 class="mt-3">Siste nyheter</h4>
                  <ul class="list-group">
                    {% for news in analysis.recent_news %}
                    <li class="list-group-item">
                      <h5>{{ news.title }}</h5>
                      <p>{{ news.summary }}</p>
                      <small class="text-muted">{{ news.date }} - {{ news.source }}</small>
                    </li>
                    {% endfor %}
                  </ul>
                  {% endif %}
                </div>
              </div>
              
              <h3 class="mb-3">Konklusjon</h3>
              <div class="card mb-4">
                <div class="card-body">
                  <p>{{ analysis.conclusion }}</p>
                </div>
              </div>
              
              <div class="d-flex gap-2">
                <a href="{{ url_for('stocks.details', ticker=ticker) }}" class="btn btn-info">Teknisk analyse</a>
                <a href="{{ url_for('analysis.prediction', ticker=ticker) }}" class="btn btn-primary">Kursprediksjon</a>
              </div>
            </div>
            
            <div class="col-md-4">
              <div class="card mb-4">
                <div class="card-header">Sammendrag</div>
                <div class="card-body">
                  <p><strong>Signal:</strong> 
                    <span class="badge {% if analysis.signal == 'BUY' %}bg-success{% elif analysis.signal == 'SELL' %}bg-danger{% else %}bg-secondary{% endif %}">
                      {{ analysis.signal }}
                    </span>
                  </p>
                  <p><strong>Konfidensgrad:</strong> {{ analysis.confidence }}</p>
                  <p><strong>Risiko:</strong> {{ analysis.risk }}</p>
                  <p><strong>Tidshorisont:</strong> {{ analysis.timeframe }}</p>
                  <p><strong>Kursmål:</strong> {{ analysis.price_target }}</p>
                </div>
              </div>
              
              <div class="card mb-4">
                <div class="card-header">Historisk utvikling</div>
                <div class="card-body">
                  <div id="price-chart" style="height: 250px;"></div>
                </div>
              </div>
              
              <div class="card">
                <div class="card-header">Sammenligning med sektor</div>
                <div class="card-body">
                  <table class="table table-sm">
                    <tr>
                      <th>Metrikkk</th>
                      <th>{{ ticker }}</th>
                      <th>Sektor</th>
                    </tr>
                    <tr>
                      <td>P/E</td>
                      <td>{{ analysis.metrics.pe_ratio|default('N/A') }}</td>
                      <td>{{ analysis.sector_metrics.pe_ratio|default('N/A') }}</td>
                    </tr>
                    <tr>
                      <td>EPS-vekst</td>
                      <td>{{ analysis.metrics.eps_growth|default('N/A') }}</td>
                      <td>{{ analysis.sector_metrics.eps_growth|default('N/A') }}</td>
                    </tr>
                    <tr>
                      <td>Utbytte</td>
                      <td>{{ analysis.metrics.dividend_yield|default('N/A') }}</td>
                      <td>{{ analysis.sector_metrics.dividend_yield|default('N/A') }}</td>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
          </div>
        {% else %}
          <div class="alert alert-warning">
            <p>Kunne ikke generere AI-analyse for denne aksjen.</p>
          </div>
        {% endif %}
      </div>
    </div>
  {% else %}
    <!-- Stock Selection Form -->
    <div class="card">
      <div class="card-header">Velg aksje for AI-analyse</div>
      <div class="card-body">
        <form action="{{ url_for('analysis.ai') }}" method="get">
          <div class="mb-3">
            <label for="ticker" class="form-label">Aksjesymbol:</label>
            <input type="text" class="form-control" id="ticker" name="ticker" 
                   placeholder="f.eks. EQNR.OL" required>
            <div class="form-text">Skriv inn aksjesymbolet slik det vises på Yahoo Finance.</div>
          </div>
          <button type="submit" class="btn btn-primary">Analyser</button>
        </form>
        
        <div class="mt-4">
          <h3>Populære aksjer</h3>
          <div class="row">
            <div class="col-md-4">
              <div class="list-group">
                <a href="{{ url_for('analysis.ai', ticker='EQNR.OL') }}" class="list-group-item list-group-item-action">Equinor (EQNR.OL)</a>
                <a href="{{ url_for('analysis.ai', ticker='DNB.OL') }}" class="list-group-item list-group-item-action">DNB Bank (DNB.OL)</a>
                <a href="{{ url_for('analysis.ai', ticker='NHY.OL') }}" class="list-group-item list-group-item-action">Norsk Hydro (NHY.OL)</a>
              </div>
            </div>
            <div class="col-md-4">
              <div class="list-group">
                <a href="{{ url_for('analysis.ai', ticker='AAPL') }}" class="list-group-item list-group-item-action">Apple (AAPL)</a>
                <a href="{{ url_for('analysis.ai', ticker='MSFT') }}" class="list-group-item list-group-item-action">Microsoft (MSFT)</a>
                <a href="{{ url_for('analysis.ai', ticker='GOOGL') }}" class="list-group-item list-group-item-action">Alphabet (GOOGL)</a>
              </div>
            </div>
            <div class="col-md-4">
              <div class="list-group">
                <a href="{{ url_for('analysis.ai', ticker='BTC-USD') }}" class="list-group-item list-group-item-action">Bitcoin (BTC-USD)</a>
                <a href="{{ url_for('analysis.ai', ticker='ETH-USD') }}" class="list-group-item list-group-item-action">Ethereum (ETH-USD)</a>
                <a href="{{ url_for('analysis.ai', ticker='EURUSD=X') }}" class="list-group-item list-group-item-action">EUR/USD (EURUSD=X)</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</div>

{% if ticker and analysis %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Sample data for chart - in a real app this would come from the server
    const dates = ['2025-01-01', '2025-02-01', '2025-03-01', '2025-04-01', '2025-05-01', '2025-06-01'];
    const prices = [100, 105, 103, 110, 108, 115];
    
    const trace = {
      x: dates,
      y: prices,
      type: 'scatter',
      mode: 'lines',
      name: '{{ ticker }}',
      line: {
        color: '#0d6efd',
        width: 2
      }
    };
    
    const layout = {
      margin: { t: 10, r: 10, l: 40, b: 40 },
      xaxis: {
        showgrid: false
      },
      yaxis: {
        showgrid: true
      }
    };
    
    Plotly.newPlot('price-chart', [trace], layout);
  });
</script>
{% endif %}
{% endblock %}
